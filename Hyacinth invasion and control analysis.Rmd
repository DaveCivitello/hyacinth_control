---
title: "Hyacinth invasion and control analysis"
author: "DJC"
date: "9/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Analysis for Dan's Chapter 3

We're going to use interrupted time series GAMMs to analyze Dan's mesocosm experiment that assessed the effects of water hyacinth invasion and control on schisto.

# Data
First, we need to bring in the data, which are in three sheets (along with a 4th sheet that contains the treatment labels for tanks)

## Egg data
```{r egg_data}
setwd("C:/RData/Dan dissertation")

# Egg count master sheet 
eggs = read.csv("Summer2019Eggs.csv")

# Egg master sheet has the number of observed eggs (not egg masses!) in each tank that had any. So, we need to sum up and
# add in zeros for those tank-dates where no eggs were found
Eggs = aggregate(Eggs.mass ~ Tank*Week, FUN=sum, data=eggs, drop=F)
Eggs[which(is.na(Eggs[,"Eggs.mass"])),"Eggs.mass"] = 0

# Other data sheets have eggs on "week zero", we want to add NAs so that the data sheets eventually align
Eggs0 = data.frame("Tank" = c(1:10, 12:23, 27:40), "Week" = 0, "Eggs.mass" = NA)
# Egg data is now in correct orientation
Eggs = rbind(Eggs0, Eggs)
Eggs
```
## Cerc, plant, and Periphyton data

```{r}

CercsPlantsPeri = subset(read.csv("Summer2019HyacinthExpMaster.csv"), !Tank %in% c(11, 24:26), select=c("Tank","Week", "Plant.mass", "Cercs", "Peri"))


```


## Snail data 
```{r snail_data}
hya = read.csv("Hyacinth_control_MASTER_041421.csv")
hya[,"Tank"] = as.factor(hya[,"Tank"])
hya[,"Biomass"] = 0.0096*hya[,"Length"]^3

abundance = aggregate(Length ~ Tank*Week, data=hya, FUN=length, drop=F)

labels = subset(read.csv("Dan_hyacinth_labels.csv"), !(Tank %in% c(11, 24:26)))

abundance = cbind(labels,"Week" = abundance$Week, "Abundance" = abundance$Length)
biomass = aggregate(Biomass ~ Tank*Week, data=hya, FUN=sum, drop=F)

tank_summary = cbind(abundance, "Biomass" =  biomass$Biomass, "Eggs" = Eggs$Eggs.mass, "Plants" = CercsPlantsPeri$Plant.mass, "Cercariae" = CercsPlantsPeri$Cercs, "Periphyton" = CercsPlantsPeri$Peri)

# treatment_summary
SEM = function(x){sd(x)/sqrt(na.omit(length(x)))}

mean_abundance = aggregate(Abundance ~ Plant*Management*Week, FUN=mean, data=tank_summary, na.action = na.omit)
SE_abundance = aggregate(Abundance ~ Plant*Management*Week, FUN=SEM, data=tank_summary, na.action = na.omit)

mean_biomass = aggregate(Biomass ~ Plant*Management*Week, FUN=mean, data=tank_summary, na.action = na.omit)
SE_biomass = aggregate(Biomass ~ Plant*Management*Week, FUN=SEM, data=tank_summary, na.action = na.omit)

treatment_summary = data.frame(mean_abundance, "Abundance_SE" = SE_abundance$Abundance,
                               "Biomass" = mean_biomass$Biomass, "Biomass_SE" = SE_biomass$Biomass)

treatment_summary
```
# Plots

```{r}
p1 = ggplot(data=treatment_summary, aes(x=Week, y=Abundance, 
            group=interaction(Plant, Management)), colour=interaction(Plant, Management)) + 
  theme(legend.position = c(0.1, 0.9))+
  ylab("Snail abundance Â± SE") +
  geom_point(aes(colour=interaction(Plant, Management))) +
  geom_linerange(aes(ymin = Abundance - Abundance_SE, ymax=Abundance + Abundance_SE, colour=interaction(Plant, Management))) +
  geom_line(aes(colour=interaction(Plant, Management)))

p1
```

```{r invasion_effects}
library(mgcv)
invasion = subset(tank_summary, Management == "none ")
invasion[,"IsHyacinth"] = ifelse(invasion[,"Plant"]=="Hyacinth", 1, 0)
invasion[,"Tank"] = as.factor(invasion[,"Tank"])
invasion2 = subset(invasion, is.finite(Abundance))

m1 = gamm(Abundance ~ s(Week)+ s(Week, by = IsHyacinth)+ s(Tank, bs="re"), niterPQL=50,
           family=quasipoisson, correlation=corCAR1(form=~Week|Tank), data=invasion2)
summary(m1$gam)
plot(m1$gam) # Significantly more snails in Week ~5, significantly fewer in weeks 8+

invasion2 = subset(invasion, is.finite(Biomass))

m2 = gamm(Biomass ~ s(Week)+ s(Week, by = IsHyacinth)+ s(Tank, bs="re"), niterPQL=50,
           family=Gamma(link="log"), correlation=corCAR1(form=~Week|Tank), data=invasion2)
summary(m2$gam)
plot(m2$gam) # Significantly more biomass in Week ~5, significantly less in weeks 8+

invasion2 = subset(invasion, is.finite(Periphyton))

m3 = gamm(Periphyton ~ s(Week, k=8)+ s(Week, by = IsHyacinth, k=8)+ s(Tank, bs="re"), niterPQL=50,
           family=Gamma(link="log"), correlation=corCAR1(form=~Week|Tank), data=invasion2)
summary(m3$gam)
plot(m3$gam) # Significantly less peruphyton the whole time

invasion4 = subset(invasion, is.finite(Eggs))

m4 = gamm(Eggs ~ s(Week)+ s(Week, by = IsHyacinth)+ s(Tank, bs="re"), niterPQL=50,
           family=quasipoisson, correlation=corCAR1(form=~Week|Tank), data=invasion4)
summary(m4$gam)
plot(m4$gam) # Significantly fewer eggs from Week ~2 on

invasion5 = subset(invasion, is.finite(Cercariae))

m5 = gamm(Cercariae ~ s(Week)+ s(Week, by = IsHyacinth)+ s(Tank, bs="re"), niterPQL=50,
           family=quasipoisson, correlation=corCAR1(form=~Week|Tank), data=invasion5)
summary(m5$gam)
plot(m5$gam) # significantly more cercariae throughout almost the whole experiment

```


```{r management_effects}
management = subset(tank_summary, Plant == "Hyacinth")
head(management)
# "intervened" accounts for a "step effect" of intervention, but have to dummy label by treatment
management[,"intervened"] = ifelse(management[,"Management"]  != "none " & management[,"Week"] > 7, 1, 0)
management[,"removed"] = ifelse(management[,"intervened"] & management[,"Management"] == "remove", 1, 0)
management[,"chopped"] = ifelse(management[,"intervened"] & management[,"Management"] == "Chop", 1, 0)


# "XXX_time" accounts for nonlinear effect of that intervention
management[,"chop_time"] = pmax(0, (management[,"chopped"]*management[,"Week"]) - 7)
management[,"removed_time"] = pmax(0, (management[,"removed"]*management[,"Week"]) - 7)

management[,"Management"] = as.factor(management[,"Management"])
management[,"Tank"] = as.factor(management[,"Tank"])


management1 = subset(management, is.finite(Abundance))

m1 = gamm(Abundance ~ s(Week) + removed + chopped + s(chop_time) + s(removed_time) + s(Tank, bs="re"), 
          niterPQL=50, family=quasipoisson, correlation=corCAR1(form=~Week|Tank), data=management1,   
          control=list(msMaxIter=100))
summary(m1$gam)
plot(m1$gam) # No significant diffs

management2 = subset(management, is.finite(Biomass))

m2 = gamm(Biomass ~  s(Week) + removed + chopped + s(chop_time) + s(removed_time) + s(Tank, bs="re"), niterPQL=50,
           family=Gamma(link="log"), correlation=corCAR1(form=~Week|Tank), data=management2)
summary(m2$gam)
plot(m2$gam) # Chopped caused a bump in biomass

management3 = subset(management, is.finite(Periphyton))

m3 = gamm(Periphyton ~ s(Week, k=8) + removed + chopped + s(chop_time, k=4) + s(removed_time, k=4) + 
          s(Tank, bs="re"), niterPQL=50, family=Gamma(link="log"), correlation=corCAR1(form=~Week|Tank), 
          data=management3)
summary(m3$gam)
plot(m3$gam) # Chopped caused more periphyton over remaining course of experiment

management4 = subset(management, is.finite(Eggs))

m4 = gamm(Eggs ~  s(Week) + removed + chopped + s(chop_time) + s(removed_time) + s(Tank, bs="re"), niterPQL=50,
           family=quasipoisson, correlation=corCAR1(form=~Week|Tank), data=management4)
summary(m4$gam)
plot(m4$gam) # Both interventions very significant

management5 = subset(management, is.finite(Cercariae))

m5 = gamm(Cercariae ~ s(Week) + removed + chopped + s(chop_time) + s(removed_time) + s(Tank, bs="re"), niterPQL=50,
           family=quasipoisson, correlation=corCAR1(form=~Week|Tank), data=management5)
summary(m5$gam)
plot(m5$gam) # No differences in cercs

```



## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
